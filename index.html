<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Clubes Escolares</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Bibliotecas para exportação -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 100; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgb(0,0,0); /* Fallback color */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            transition: opacity 0.3s ease;
        }
        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 0.5rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .kanban-column {
            min-height: 200px;
        }
        .color-swatch {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }
        .color-swatch.selected {
            border-color: #4f46e5; /* indigo-600 */
            transform: scale(1.1);
        }
        /* Estilos para impressão do portfólio */
        @media print {
            body * {
                visibility: hidden;
            }
            #portfolio-print-area, #portfolio-print-area * {
                visibility: visible;
            }
            #portfolio-print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            .no-print {
                display: none !important;
            }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Container Principal -->
    <div id="app" class="container mx-auto p-4 md:p-8 max-w-7xl">

        <!-- Ecrã de Autenticação/Login -->
        <div id="auth-screen">
            <div class="max-w-md mx-auto bg-white rounded-xl shadow-md overflow-hidden md:max-w-2xl mt-10 p-8">
                <div class="text-center">
                    <h1 class="text-2xl font-bold text-indigo-600">Bem-vindo ao Gestor de Clubes Escolares</h1>
                    <p class="mt-2 text-gray-500">Escolha um método de login para começar.</p>
                    <div id="auth-container" class="mt-6 space-y-4">
                         <button id="google-login-button" class="w-full bg-white border border-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-50 transition duration-300 flex items-center justify-center">
                            <i class="fa-brands fa-google text-lg mr-3"></i>
                            <span>Entrar com Google</span>
                        </button>
                         <button id="anonymous-login-button" class="w-full bg-gray-700 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-800 transition duration-300 flex items-center justify-center">
                            <i class="fas fa-user-secret mr-2"></i><span>Entrar como Utilizador Anónimo</span>
                        </button>
                        <p class="text-xs text-gray-400 mt-4">O seu ID de utilizador único será gerado e apresentado no painel principal.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ecrã Principal da Aplicação (visível após login) -->
        <div id="main-app" class="hidden">
            <!-- Cabeçalho -->
            <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8 no-print">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">Gestor de Clubes</h1>
                    <p id="user-info" class="text-sm text-gray-500 mt-1"></p>
                </div>
                <button id="logout-button" class="bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600 transition duration-300 mt-4 sm:mt-0">
                    <i class="fas fa-sign-out-alt mr-2"></i>Sair
                </button>
            </header>

            <!-- Ecrã da Lista de Clubes -->
            <div id="clubs-list-screen" class="no-print">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                    <h2 class="text-2xl font-semibold">Os Meus Clubes</h2>
                    <div class="flex items-center gap-4 w-full md:w-auto">
                        <input type="text" id="search-clubs-input" placeholder="Pesquisar clubes..." class="w-full md:w-64 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <button id="add-club-button" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition duration-300">
                            <i class="fas fa-plus mr-2"></i>Novo
                        </button>
                    </div>
                </div>
                <div id="clubs-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Os cartões dos clubes serão inseridos aqui -->
                </div>
                 <p id="no-clubs-message" class="text-gray-500 col-span-full hidden">Ainda não criou nenhum clube. Clique em "Novo" para começar.</p>
                 <p id="no-search-results" class="text-gray-500 col-span-full hidden">Nenhum clube encontrado com esse termo de pesquisa.</p>
            </div>

            <!-- Ecrã de Gestão de um Clube Específico -->
            <div id="club-management-screen" class="hidden">
                <div id="club-management-content" class="bg-white p-6 rounded-xl shadow-lg">
                    <div class="flex justify-between items-start no-print">
                        <div>
                            <h2 id="club-name-title" class="text-3xl font-bold"></h2>
                            <p id="club-description-title" class="text-gray-600 mt-1"></p>
                        </div>
                        <button id="back-to-clubs-list" class="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition duration-300">
                            <i class="fas fa-arrow-left mr-2"></i>Voltar
                        </button>
                    </div>

                    <!-- Abas de Navegação -->
                    <div class="border-b border-gray-200 mt-6 overflow-x-auto no-print">
                        <nav id="club-tabs" class="-mb-px flex space-x-6" aria-label="Tabs">
                            <!-- As abas serão geradas aqui -->
                        </nav>
                    </div>

                    <!-- Conteúdo das Abas -->
                    <div id="club-tab-content" class="mt-6">
                        <!-- O conteúdo de cada aba será renderizado aqui -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Adicionar/Editar Clube -->
    <div id="club-modal" class="modal">
        <div class="modal-content">
            <h3 id="club-modal-title" class="text-xl font-bold mb-4">Novo Clube</h3>
            <form id="club-form">
                <input type="hidden" id="club-id-input">
                <div class="mb-4">
                    <label for="club-name" class="block text-sm font-medium text-gray-700">Nome do Clube</label>
                    <input type="text" id="club-name" name="club-name" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required>
                </div>
                <div class="mb-4">
                    <label for="club-description" class="block text-sm font-medium text-gray-700">Descrição</label>
                    <textarea id="club-description" name="club-description" rows="3" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                </div>
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700">Cor do Clube</label>
                    <div id="color-palette" class="mt-2 flex flex-wrap gap-3">
                        <!-- As cores serão inseridas aqui -->
                    </div>
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" id="cancel-club-modal" class="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">Cancelar</button>
                    <button type="submit" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700">Guardar</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal Genérico para Confirmação -->
    <div id="confirm-modal" class="modal">
        <div class="modal-content">
             <h3 class="text-xl font-bold mb-2">Confirmar Ação</h3>
             <p id="confirm-modal-text" class="mb-6">Tem a certeza que deseja realizar esta ação?</p>
             <div class="flex justify-end gap-4">
                 <button id="cancel-confirm-modal" class="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">Cancelar</button>
                 <button id="confirm-action-button" class="bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600">Confirmar</button>
             </div>
        </div>
    </div>

    <!-- Modal para Erros -->
    <div id="error-modal" class="modal">
        <div class="modal-content">
             <h3 class="text-xl font-bold mb-2 text-red-600"><i class="fas fa-exclamation-triangle mr-2"></i>Ocorreu um Erro</h3>
             <p id="error-modal-text" class="mb-6">Ocorreu um erro inesperado.</p>
             <div class="flex justify-end">
                 <button id="close-error-modal" class="bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600">Fechar</button>
             </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        // Importações do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut, signInWithCustomToken, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, addDoc, getDoc, getDocs, setDoc, deleteDoc, onSnapshot, query, where, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURAÇÃO E INICIALIZAÇÃO ---
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'gestor-clubes-dev';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- ESTADO DA APLICAÇÃO ---
        let currentUser = null;
        let userId = null;
        let currentClubId = null;
        let unsubscribeClubs = null;
        let unsubscribeClubData = {};

        // --- ELEMENTOS DO DOM ---
        const authScreen = document.getElementById('auth-screen');
        const mainApp = document.getElementById('main-app');
        const googleLoginButton = document.getElementById('google-login-button');
        const anonymousLoginButton = document.getElementById('anonymous-login-button');
        const logoutButton = document.getElementById('logout-button');
        const userInfoDisplay = document.getElementById('user-info');
        
        const clubsListScreen = document.getElementById('clubs-list-screen');
        const clubsContainer = document.getElementById('clubs-container');
        const noClubsMessage = document.getElementById('no-clubs-message');
        const noSearchResults = document.getElementById('no-search-results');
        const addClubButton = document.getElementById('add-club-button');
        const searchClubsInput = document.getElementById('search-clubs-input');

        const clubManagementScreen = document.getElementById('club-management-screen');
        const backToClubsListButton = document.getElementById('back-to-clubs-list');
        const clubNameTitle = document.getElementById('club-name-title');
        const clubDescriptionTitle = document.getElementById('club-description-title');
        const clubTabs = document.getElementById('club-tabs');
        const clubTabContent = document.getElementById('club-tab-content');

        const clubModal = document.getElementById('club-modal');
        const clubModalTitle = document.getElementById('club-modal-title');
        const clubForm = document.getElementById('club-form');
        const cancelClubModalButton = document.getElementById('cancel-club-modal');
        const clubIdInput = document.getElementById('club-id-input');
        const colorPalette = document.getElementById('color-palette');

        const confirmModal = document.getElementById('confirm-modal');
        const confirmModalText = document.getElementById('confirm-modal-text');
        const cancelConfirmModalButton = document.getElementById('cancel-confirm-modal');
        const confirmActionButton = document.getElementById('confirm-action-button');
        
        const errorModal = document.getElementById('error-modal');
        const errorModalText = document.getElementById('error-modal-text');
        const closeErrorModalButton = document.getElementById('close-error-modal');
        
        const CLUB_COLORS = ['#ef4444', '#f97316', '#eab308', '#84cc16', '#22c55e', '#14b8a6', '#06b6d4', '#3b82f6', '#8b5cf6', '#d946ef', '#ec4899'];

        // --- FUNÇÕES DE UTILIDADE ---
        function showModal(modal) { modal.style.display = 'block'; }
        function hideModal(modal) { modal.style.display = 'none'; }
        
        function showErrorModal(message) {
            errorModalText.textContent = message;
            showModal(errorModal);
        }
        closeErrorModalButton.addEventListener('click', () => hideModal(errorModal));

        function showConfirmModal(text, onConfirm) {
            confirmModalText.textContent = text;
            showModal(confirmModal);
            const newConfirmButton = confirmActionButton.cloneNode(true);
            confirmActionButton.parentNode.replaceChild(newConfirmButton, confirmActionButton);
            newConfirmButton.addEventListener('click', () => {
                onConfirm();
                hideModal(confirmModal);
            }, { once: true });
        }
        cancelConfirmModalButton.addEventListener('click', () => hideModal(confirmModal));

        // --- LÓGICA DE AUTENTICAÇÃO ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                userId = user.uid;
                // CORRECÇÃO: Garantir que a mensagem para utilizadores anónimos é sempre a correcta.
                if (user.isAnonymous || (!user.displayName && !user.email)) {
                    userInfoDisplay.innerHTML = `ID de Utilizador: <span class="font-mono bg-gray-200 px-2 py-1 rounded">${userId}</span>`;
                } else {
                    userInfoDisplay.innerHTML = `Bem-vindo(a), <span class="font-semibold">${user.displayName || user.email}</span>`;
                }
                authScreen.classList.add('hidden');
                mainApp.classList.remove('hidden');
                showClubsListScreen();
                listenToClubs();
            } else {
                currentUser = null;
                userId = null;
                authScreen.classList.remove('hidden');
                mainApp.classList.add('hidden');
                if (unsubscribeClubs) unsubscribeClubs();
                Object.values(unsubscribeClubData).forEach(clubUnsubs => {
                    Object.values(clubUnsubs).forEach(unsub => unsub && unsub());
                });
                unsubscribeClubData = {};
            }
        });

        async function handleLogin(loginFn) {
            try {
                await loginFn();
            } catch (error) {
                console.error("Erro ao fazer login:", error);
                let message = `Não foi possível fazer login. Verifique a sua ligação ou tente novamente mais tarde.`;
                if (error.code === 'auth/popup-closed-by-user') {
                    message = 'A janela de login foi fechada antes da autenticação ser concluída.';
                } else if (error.code === 'auth/unauthorized-domain') {
                    message = 'O login com Google não está ativo neste domínio. Por favor, utilize a opção "Entrar como Utilizador Anónimo" para aceder à aplicação.';
                }
                showErrorModal(message);
            }
        }

        googleLoginButton.addEventListener('click', () => handleLogin(async () => {
            const provider = new GoogleAuthProvider();
            await signInWithPopup(auth, provider);
        }));

        anonymousLoginButton.addEventListener('click', () => handleLogin(async () => {
             if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        }));

        logoutButton.addEventListener('click', () => {
            signOut(auth);
        });

        // --- LÓGICA DE NAVEGAÇÃO E PESQUISA ---
        function showClubsListScreen() {
            clubManagementScreen.classList.add('hidden');
            clubsListScreen.classList.remove('hidden');
            currentClubId = null;
            Object.values(unsubscribeClubData).forEach(clubUnsubs => {
                Object.values(clubUnsubs).forEach(unsub => unsub && unsub());
            });
            unsubscribeClubData = {};
        }

        function showClubManagementScreen(clubId) {
            clubsListScreen.classList.add('hidden');
            clubManagementScreen.classList.remove('hidden');
            currentClubId = clubId;
            renderTabs();
            navigateToTab('membros');
        }
        
        backToClubsListButton.addEventListener('click', showClubsListScreen);
        
        searchClubsInput.addEventListener('keyup', () => {
            const searchTerm = searchClubsInput.value.toLowerCase();
            const clubCards = document.querySelectorAll('.club-card');
            let visibleCount = 0;
            clubCards.forEach(card => {
                const clubName = card.dataset.name.toLowerCase();
                const clubDescription = card.dataset.description.toLowerCase();
                if (clubName.includes(searchTerm) || clubDescription.includes(searchTerm)) {
                    card.style.display = 'flex';
                    visibleCount++;
                } else {
                    card.style.display = 'none';
                }
            });
            noSearchResults.style.display = visibleCount === 0 && clubCards.length > 0 ? 'block' : 'none';
        });

        // --- LÓGICA DE CLUBES (CRUD) ---
        function listenToClubs() {
            if (unsubscribeClubs) unsubscribeClubs();
            const clubsRef = collection(db, `artifacts/${appId}/users/${userId}/clubs`);
            unsubscribeClubs = onSnapshot(clubsRef, (snapshot) => {
                clubsContainer.innerHTML = '';
                noClubsMessage.style.display = snapshot.empty ? 'block' : 'none';
                noSearchResults.style.display = 'none';
                searchClubsInput.value = '';

                snapshot.forEach(doc => {
                    const club = { id: doc.id, ...doc.data() };
                    renderClubCard(club);
                });
            }, (error) => {
                console.error("Erro a ouvir os clubes:", error);
                showErrorModal("Não foi possível carregar a lista de clubes.");
            });
        }

        function renderClubCard(club) {
            const card = document.createElement('div');
            card.className = 'club-card bg-white p-6 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300 flex flex-col justify-between';
            card.style.borderTop = `5px solid ${club.color || '#6366f1'}`;
            card.dataset.name = club.name;
            card.dataset.description = club.description || '';
            
            card.innerHTML = `
                <div>
                    <h3 class="text-xl font-bold text-gray-800">${club.name}</h3>
                    <p class="text-gray-600 mt-2 h-12 overflow-hidden text-ellipsis">${club.description || 'Sem descrição.'}</p>
                </div>
                <div class="mt-4 flex justify-end gap-2">
                    <button data-action="manage" class="flex-grow text-center bg-gray-100 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-200 transition">Gerir</button>
                    <button data-action="edit" title="Editar" class="text-gray-500 hover:text-indigo-600 p-2"><i class="fas fa-edit"></i></button>
                    <button data-action="delete" title="Apagar" class="text-gray-500 hover:text-red-600 p-2"><i class="fas fa-trash"></i></button>
                </div>
            `;
            card.querySelector('[data-action="manage"]').addEventListener('click', () => showClubManagementScreen(club.id));
            card.querySelector('[data-action="edit"]').addEventListener('click', () => openClubModal(club));
            card.querySelector('[data-action="delete"]').addEventListener('click', () => {
                showConfirmModal(`Tem a certeza que quer apagar o clube "${club.name}"? Esta ação é irreversível.`, () => deleteClub(club.id));
            });
            clubsContainer.appendChild(card);
        }

        addClubButton.addEventListener('click', () => openClubModal());
        
        function setupColorPalette(selectedColor) {
            colorPalette.innerHTML = '';
            CLUB_COLORS.forEach(color => {
                const swatch = document.createElement('div');
                swatch.className = 'color-swatch';
                swatch.style.backgroundColor = color;
                swatch.dataset.color = color;
                if (color === selectedColor) {
                    swatch.classList.add('selected');
                }
                swatch.addEventListener('click', () => {
                    colorPalette.querySelector('.selected')?.classList.remove('selected');
                    swatch.classList.add('selected');
                });
                colorPalette.appendChild(swatch);
            });
        }

        function openClubModal(club = null) {
            clubForm.reset();
            clubIdInput.value = '';
            if (club) {
                clubModalTitle.textContent = 'Editar Clube';
                clubIdInput.value = club.id;
                document.getElementById('club-name').value = club.name;
                document.getElementById('club-description').value = club.description;
                setupColorPalette(club.color || CLUB_COLORS[0]);
            } else {
                clubModalTitle.textContent = 'Novo Clube';
                setupColorPalette(CLUB_COLORS[0]);
            }
            showModal(clubModal);
        }

        cancelClubModalButton.addEventListener('click', () => hideModal(clubModal));

        clubForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = clubIdInput.value;
            const name = document.getElementById('club-name').value;
            const description = document.getElementById('club-description').value;
            const selectedColor = colorPalette.querySelector('.selected')?.dataset.color || CLUB_COLORS[0];

            const clubData = { name, description, color: selectedColor };

            try {
                if (id) { // Editar
                    const clubRef = doc(db, `artifacts/${appId}/users/${userId}/clubs`, id);
                    await updateDoc(clubRef, clubData);
                } else { // Criar
                    const clubsRef = collection(db, `artifacts/${appId}/users/${userId}/clubs`);
                    await addDoc(clubsRef, { ...clubData, createdAt: new Date() });
                }
                hideModal(clubModal);
            } catch (error) {
                console.error("Erro ao guardar o clube:", error);
                showErrorModal("Não foi possível guardar o clube.");
            }
        });

        async function deleteClub(clubId) {
            try {
                const clubRef = doc(db, `artifacts/${appId}/users/${userId}/clubs`, clubId);
                await deleteDoc(clubRef);
            } catch (error) {
                console.error("Erro ao apagar o clube:", error);
                showErrorModal("Não foi possível apagar o clube.");
            }
        }

        // --- LÓGICA DAS ABAS DO CLUBE ---
        const TABS = {
            membros: { label: 'Membros', icon: 'fa-users', render: renderMembersTab },
            presencas: { label: 'Presenças', icon: 'fa-check-square', render: renderAttendanceTab },
            metas: { label: 'Metas', icon: 'fa-bullseye', render: renderGoalsTab },
            calendario: { label: 'Calendário', icon: 'fa-calendar-alt', render: renderCalendarTab },
            anuncios: { label: 'Anúncios', icon: 'fa-bullhorn', render: renderAnnouncementsTab },
            projetos: { label: 'Projetos', icon: 'fa-tasks', render: renderProjectsTab },
            recursos: { label: 'Recursos', icon: 'fa-folder-open', render: renderResourcesTab },
            portfolio: { label: 'Portfólio', icon: 'fa-book-open', render: renderPortfolioTab },
        };

        function renderTabs() {
            clubTabs.innerHTML = '';
            Object.keys(TABS).forEach(tabKey => {
                const tabInfo = TABS[tabKey];
                const tabButton = document.createElement('a');
                tabButton.href = '#';
                tabButton.dataset.tab = tabKey;
                tabButton.className = 'whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300';
                tabButton.innerHTML = `<i class="fas ${tabInfo.icon} mr-2"></i>${tabInfo.label}`;
                tabButton.addEventListener('click', (e) => {
                    e.preventDefault();
                    navigateToTab(tabKey);
                });
                clubTabs.appendChild(tabButton);
            });
        }
        
        async function navigateToTab(tabKey) {
            document.querySelectorAll('#club-tabs a').forEach(tab => {
                if (tab.dataset.tab === tabKey) {
                    tab.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                    tab.classList.add('border-indigo-500', 'text-indigo-600');
                } else {
                    tab.classList.remove('border-indigo-500', 'text-indigo-600');
                    tab.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                }
            });

            if (unsubscribeClubData[currentClubId]) {
                Object.values(unsubscribeClubData[currentClubId]).forEach(unsub => unsub && unsub());
            }
            unsubscribeClubData[currentClubId] = {};
            
            clubTabContent.innerHTML = '<div class="text-center p-8"><i class="fas fa-spinner fa-spin text-3xl text-indigo-500"></i></div>';
            
            try {
                const clubRef = doc(db, `artifacts/${appId}/users/${userId}/clubs`, currentClubId);
                const clubSnap = await getDoc(clubRef);
                if(clubSnap.exists()){
                    const clubData = clubSnap.data();
                    clubNameTitle.textContent = clubData.name;
                    clubNameTitle.style.color = clubData.color || '#1f2937';
                    clubDescriptionTitle.textContent = clubData.description;
                    TABS[tabKey].render();
                } else {
                    showErrorModal("O clube selecionado já não existe.");
                    showClubsListScreen();
                }
            } catch (error) {
                 console.error("Erro ao carregar dados do clube:", error);
                 showErrorModal("Não foi possível carregar os dados do clube.");
            }
        }

        // --- ABA: MEMBROS ---
        function renderMembersTab() {
            clubTabContent.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold">Lista de Membros</h3>
                    <div class="flex gap-2">
                        <button id="export-members-csv" class="bg-green-500 text-white font-bold py-2 px-3 rounded-lg hover:bg-green-600 text-sm"><i class="fas fa-file-csv mr-1"></i> CSV</button>
                        <button id="export-members-pdf" class="bg-red-500 text-white font-bold py-2 px-3 rounded-lg hover:bg-red-600 text-sm"><i class="fas fa-file-pdf mr-1"></i> PDF</button>
                    </div>
                </div>
                <form id="add-member-form" class="flex gap-2 mb-4">
                    <input type="text" id="member-name-input" placeholder="Nome do novo membro" class="flex-grow px-3 py-2 border border-gray-300 rounded-md" required>
                    <button type="submit" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600"><i class="fas fa-plus"></i> Adicionar</button>
                </form>
                <div id="members-list" class="space-y-2"></div>
            `;
            
            document.getElementById('export-members-csv').addEventListener('click', exportMembersToCSV);
            document.getElementById('export-members-pdf').addEventListener('click', exportMembersToPDF);

            const membersRef = collection(db, `artifacts/${appId}/users/${userId}/clubs/${currentClubId}/members`);
            unsubscribeClubData[currentClubId] = unsubscribeClubData[currentClubId] || {};
            unsubscribeClubData[currentClubId].members = onSnapshot(membersRef, (snapshot) => {
                const membersList = document.getElementById('members-list');
                if (!membersList) return;
                membersList.innerHTML = '';
                if(snapshot.empty){
                    membersList.innerHTML = '<p class="text-gray-500">Nenhum membro adicionado a este clube.</p>';
                } else {
                    snapshot.forEach(doc => {
                        const member = { id: doc.id, ...doc.data() };
                        const memberEl = document.createElement('div');
                        memberEl.className = 'flex justify-between items-center bg-gray-50 p-3 rounded-lg';
                        memberEl.innerHTML = `
                            <span>${member.name}</span>
                            <button class="text-red-500 hover:text-red-700"><i class="fas fa-trash-alt"></i></button>
                        `;
                        memberEl.querySelector('button').addEventListener('click', () => {
                            showConfirmModal(`Tem a certeza que quer remover "${member.name}"?`, () => deleteMember(member.id));
                        });
                        membersList.appendChild(memberEl);
                    });
                }
            });

            document.getElementById('add-member-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const input = document.getElementById('member-name-input');
                const name = input.value.trim();
                if (name) {
                    try {
                        await addDoc(membersRef, { name });
                        input.value = '';
                    } catch (error) {
                        showErrorModal("Não foi possível adicionar o membro.");
                    }
                }
            });
        }
        
        async function deleteMember(memberId) {
            try {
                const memberRef = doc(db, `artifacts/${appId}/users/${userId}/clubs/${currentClubId}/members`, memberId);
                await deleteDoc(memberRef);
            } catch (error) {
                showErrorModal("Não foi possível remover o membro.");
            }
        }
        
        // --- ABA: PRESENÇAS ---
        async function renderAttendanceTab() {
            clubTabContent.innerHTML = `
                <h3 class="text-xl font-semibold mb-4">Registo de Presenças</h3>
                <div class="flex flex-wrap items-center gap-4 mb-4">
                    <label for="attendance-date">Data:</label>
                    <input type="date" id="attendance-date" value="${new Date().toISOString().split('T')[0]}" class="px-3 py-2 border border-gray-300 rounded-md">
                    <div class="flex gap-2">
                        <button id="export-attendance-csv" class="bg-green-500 text-white font-bold py-2 px-3 rounded-lg hover:bg-green-600 text-sm"><i class="fas fa-file-csv mr-1"></i> CSV</button>
                        <button id="export-attendance-pdf" class="bg-red-500 text-white font-bold py-2 px-3 rounded-lg hover:bg-red-600 text-sm"><i class="fas fa-file-pdf mr-1"></i> PDF</button>
                    </div>
                </div>
                <div id="attendance-list">A carregar membros...</div>
            `;
            
            document.getElementById('export-attendance-csv').addEventListener('click', exportAttendanceToCSV);
            document.getElementById('export-attendance-pdf').addEventListener('click', exportAttendanceToPDF);
            const dateInput = document.getElementById('attendance-date');
            dateInput.addEventListener('change', () => loadAttendanceForDate(dateInput.value));
            
            loadAttendanceForDate(dateInput.value);
        }
        
        async function loadAttendanceForDate(dateStr) {
            const attendanceListDiv = document.getElementById('attendance-list');
            attendanceListDiv.innerHTML = '<div class="text-center p-4"><i class="fas fa-spinner fa-spin text-2xl text-indigo-500"></i></div>';
            
            try {
                const membersRef = collection(db, `artifacts/${appId}/users/${userId}/clubs/${currentClubId}/members`);
                const membersSnap = await getDocs(membersRef);
                const members = membersSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                if (members.length === 0) {
                    attendanceListDiv.innerHTML = '<p class="text-gray-500">Adicione membros ao clube para poder registar presenças.</p>';
                    return;
                }
                
                const attendanceDocId = `attendance-${dateStr}`;
                const attendanceRef = doc(db, `artifacts/${appId}/users/${userId}/clubs/${currentClubId}/attendance`, attendanceDocId);
                const attendanceSnap = await getDoc(attendanceRef);
                const presentMembers = attendanceSnap.exists() ? attendanceSnap.data().presentIds : [];

                attendanceListDiv.innerHTML = '<div class="space-y-2"></div>';
                const listContainer = attendanceListDiv.querySelector('div');

                members.forEach(member => {
                    const isPresent = presentMembers.includes(member.id);
                    const memberEl = document.createElement('div');
                    memberEl.className = 'flex justify-between items-center bg-gray-50 p-3 rounded-lg';
                    memberEl.innerHTML = `
                        <span>${member.name}</span>
                        <input type="checkbox" data-member-id="${member.id}" class="h-5 w-5 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded" ${isPresent ? 'checked' : ''}>
                    `;
                    listContainer.appendChild(memberEl);
                });
                
                listContainer.addEventListener('change', async (e) => {
                    if (e.target.type === 'checkbox') {
                        const checkboxes = listContainer.querySelectorAll('input[type="checkbox"]');
                        const newPresentIds = Array.from(checkboxes)
                            .filter(cb => cb.checked)
                            .map(cb => cb.dataset.memberId);
                        
                        await setDoc(attendanceRef, { presentIds: newPresentIds });
                    }
                });
            } catch (error) {
                console.error("Erro ao carregar presenças:", error);
                showErrorModal("Não foi possível carregar o registo de presenças.");
            }
        }
        
        // --- ABA: METAS ---
        function renderGoalsTab() {
            clubTabContent.innerHTML = `
                <h3 class="text-xl font-semibold mb-4">Metas e Objetivos</h3>
                <form id="add-goal-form" class="p-4 bg-gray-50 rounded-lg mb-6">
                    <h4 class="font-semibold mb-2">Adicionar Nova Meta</h4>
                    <div class="space-y-3">
                        <input type="text" id="goal-title" placeholder="Título da Meta" class="w-full px-3 py-2 border rounded-md" required>
                        <textarea id="goal-description" placeholder="Descrição da meta..." class="w-full px-3 py-2 border rounded-md" rows="2"></textarea>
                    </div>
                    <div class="text-right mt-3">
                        <button type="submit" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600">Adicionar Meta</button>
                    </div>
                </form>
                <div id="goals-list" class="space-y-3"></div>
            `;

            const goalsRef = collection(db, `artifacts/${appId}/users/${userId}/clubs/${currentClubId}/goals`);
            unsubscribeClubData[currentClubId].goals = onSnapshot(goalsRef, (snapshot) => {
                const goalsList = document.getElementById('goals-list');
                if (!goalsList) return;
                goalsList.innerHTML = '';
                if (snapshot.empty) {
                    goalsList.innerHTML = '<p class="text-gray-500">Nenhuma meta definida para este clube.</p>';
                } else {
                    const goals = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    goals.sort((a,b) => (a.achieved === b.achieved)? 0 : a.achieved? 1 : -1);

                    goals.forEach(goal => {
                        const goalEl = document.createElement('div');
                        goalEl.className = `p-4 rounded-lg shadow-sm flex justify-between items-start ${goal.achieved ? 'bg-green-50' : 'bg-white'}`;
                        goalEl.innerHTML = `
                            <div>
                                <p class="font-bold ${goal.achieved ? 'line-through text-gray-500' : ''}">${goal.title}</p>
                                <p class="text-sm text-gray-600 mt-1">${goal.description || 'Sem descrição.'}</p>
                            </div>
                            <div class="flex items-center gap-4 ml-4">
                                <button data-action="toggle" class="text-white font-bold py-1 px-3 rounded-lg text-sm ${goal.achieved ? 'bg-yellow-500 hover:bg-yellow-600' : 'bg-green-500 hover:bg-green-600'}">
                                    <i class="fas ${goal.achieved ? 'fa-times' : 'fa-check'}"></i> ${goal.achieved ? 'Reabrir' : 'Concluir'}
                                </button>
                                <button data-action="delete" class="text-red-500 hover:text-red-700"><i class="fas fa-trash-alt"></i></button>
                            </div>
                        `;
                        goalEl.querySelector('[data-action="toggle"]').addEventListener('click', () => toggleGoalStatus(goal.id, !goal.achieved));
                        goalEl.querySelector('[data-action="delete"]').addEventListener('click', () => deleteGoal(goal.id));
                        goalsList.appendChild(goalEl);
                    });
                }
            });

            document.getElementById('add-goal-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const title = document.getElementById('goal-title').value.trim();
                const description = document.getElementById('goal-description').value.trim();
                if (title) {
                    try {
                        await addDoc(goalsRef, { title, description, achieved: false, createdAt: new Date() });
                        e.target.reset();
                    } catch (error) { showErrorModal("Não foi possível adicionar a meta."); }
                }
            });
        }

        async function toggleGoalStatus(goalId, newStatus) {
            const goalRef = doc(db, `artifacts/${appId}/users/${userId}/clubs/${currentClubId}/goals`, goalId);
            await updateDoc(goalRef, { achieved: newStatus });
        }

        async function deleteGoal(goalId) {
            const goalRef = doc(db, `artifacts/${appId}/users/${userId}/clubs/${currentClubId}/goals`, goalId);
            await deleteDoc(goalRef);
        }
        
        // --- ABA: CALENDÁRIO ---
        function renderCalendarTab() {
            clubTabContent.innerHTML = `
                <h3 class="text-xl font-semibold mb-4">Calendário de Eventos</h3>
                <form id="add-event-form" class="p-4 bg-gray-50 rounded-lg mb-6">
                    <h4 class="font-semibold mb-2">Adicionar Novo Evento</h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <input type="text" id="event-title" placeholder="Título do Evento" class="px-3 py-2 border rounded-md" required>
                        <input type="date" id="event-date" class="px-3 py-2 border rounded-md" required>
                        <button type="submit" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600">Adicionar Evento</button>
                    </div>
                </form>
                <div id="events-list" class="space-y-3"></div>
            `;
            
            const eventsRef = collection(db, `artifacts/${appId}/users/${userId}/clubs/${currentClubId}/events`);
            unsubscribeClubData[currentClubId].events = onSnapshot(eventsRef, (snapshot) => {
                const eventsList = document.getElementById('events-list');
                if (!eventsList) return;
                eventsList.innerHTML = '';
                if (snapshot.empty) {
                    eventsList.innerHTML = '<p class="text-gray-500">Nenhum evento agendado.</p>';
                } else {
                    const events = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    events.sort((a,b) => new Date(a.date) - new Date(b.date));

                    events.forEach(event => {
                        const eventEl = document.createElement('div');
                        eventEl.className = 'flex justify-between items-center bg-white p-4 rounded-lg shadow-sm';
                        const eventDate = new Date(event.date + 'T00:00:00');
                        const formattedDate = eventDate.toLocaleDateString('pt-PT', { year: 'numeric', month: 'long', day: 'numeric' });
                        eventEl.innerHTML = `
                            <div>
                                <p class="font-bold">${event.title}</p>
                                <p class="text-sm text-gray-500">${formattedDate}</p>
                            </div>
                            <button class="text-red-500 hover:text-red-700"><i class="fas fa-trash-alt"></i></button>
                        `;
                        eventEl.querySelector('button').addEventListener('click', () => deleteEvent(event.id));
                        eventsList.appendChild(eventEl);
                    });
                }
            });

            document.getElementById('add-event-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const title = document.getElementById('event-title').value.trim();
                const date = document.getElementById('event-date').value;
                if (title && date) {
                    try {
                        await addDoc(eventsRef, { title, date });
                        e.target.reset();
                    } catch (error) { showErrorModal("Não foi possível adicionar o evento."); }
                }
            });
        }

        async function deleteEvent(eventId) {
            try {
                const eventRef = doc(db, `artifacts/${appId}/users/${userId}/clubs/${currentClubId}/events`, eventId);
                await deleteDoc(eventRef);
            } catch (error) { showErrorModal("Não foi possível apagar o evento."); }
        }
        
        // --- ABA: ANÚNCIOS ---
        function renderAnnouncementsTab() {
            clubTabContent.innerHTML = `
                <h3 class="text-xl font-semibold mb-4">Anúncios</h3>
                <form id="add-announcement-form" class="p-4 bg-gray-50 rounded-lg mb-6">
                    <h4 class="font-semibold mb-2">Publicar Novo Anúncio</h4>
                    <textarea id="announcement-content" placeholder="Escreva o seu anúncio aqui..." class="w-full px-3 py-2 border rounded-md mb-2" rows="3" required></textarea>
                    <div class="text-right">
                        <button type="submit" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600">Publicar</button>
                    </div>
                </form>
                <div id="announcements-list" class="space-y-4"></div>
            `;
            
            const announcementsRef = collection(db, `artifacts/${appId}/users/${userId}/clubs/${currentClubId}/announcements`);
            unsubscribeClubData[currentClubId].announcements = onSnapshot(announcementsRef, (snapshot) => {
                const announcementsList = document.getElementById('announcements-list');
                if (!announcementsList) return;
                announcementsList.innerHTML = '';
                if (snapshot.empty) {
                    announcementsList.innerHTML = '<p class="text-gray-500">Nenhum anúncio publicado.</p>';
                } else {
                    const announcements = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    announcements.sort((a,b) => b.createdAt.toDate() - a.createdAt.toDate());

                    announcements.forEach(announcement => {
                        const announcementEl = document.createElement('div');
                        announcementEl.className = 'bg-white p-4 rounded-lg shadow-sm border-l-4 border-indigo-500';
                        const formattedDate = announcement.createdAt.toDate().toLocaleString('pt-PT');
                        announcementEl.innerHTML = `
                            <p class="whitespace-pre-wrap">${announcement.content}</p>
                            <div class="flex justify-between items-center mt-3 text-sm text-gray-500">
                                <span>Publicado em: ${formattedDate}</span>
                                <button class="text-red-500 hover:text-red-700"><i class="fas fa-trash-alt"></i></button>
                            </div>
                        `;
                        announcementEl.querySelector('button').addEventListener('click', () => deleteAnnouncement(announcement.id));
                        announcementsList.appendChild(announcementEl);
                    });
                }
            });

            document.getElementById('add-announcement-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const content = document.getElementById('announcement-content').value.trim();
                if (content) {
                    try {
                        await addDoc(announcementsRef, { content, createdAt: new Date() });
                        e.target.reset();
                    } catch (error) { showErrorModal("Não foi possível publicar o anúncio."); }
                }
            });
        }

        async function deleteAnnouncement(announcementId) {
            try {
                const announcementRef = doc(db, `artifacts/${appId}/users/${userId}/clubs/${currentClubId}/announcements`, announcementId);
                await deleteDoc(announcementRef);
            } catch (error) { showErrorModal("Não foi possível apagar o anúncio."); }
        }

        // --- ABA: PROJETOS (KANBAN) ---
        function renderProjectsTab() {
            clubTabContent.innerHTML = `
                <h3 class="text-xl font-semibold mb-4">Quadro de Projetos (Kanban)</h3>
                <form id="add-task-form" class="flex gap-2 mb-6">
                    <input type="text" id="task-title-input" placeholder="Nova tarefa" class="flex-grow px-3 py-2 border border-gray-300 rounded-md" required>
                    <button type="submit" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600"><i class="fas fa-plus"></i> Adicionar Tarefa</button>
                </form>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-gray-100 rounded-lg p-4">
                        <h4 class="font-bold text-lg mb-4 text-center text-red-600">A Fazer</h4>
                        <div id="kanban-todo" class="kanban-column space-y-3" data-status="todo"></div>
                    </div>
                    <div class="bg-gray-100 rounded-lg p-4">
                        <h4 class="font-bold text-lg mb-4 text-center text-yellow-600">Em Progresso</h4>
                        <div id="kanban-inprogress" class="kanban-column space-y-3" data-status="inprogress"></div>
                    </div>
                    <div class="bg-gray-100 rounded-lg p-4">
                        <h4 class="font-bold text-lg mb-4 text-center text-green-600">Concluído</h4>
                        <div id="kanban-done" class="kanban-column space-y-3" data-status="done"></div>
                    </div>
                </div>
            `;
            
            const tasksRef = collection(db, `artifacts/${appId}/users/${userId}/clubs/${currentClubId}/tasks`);
            unsubscribeClubData[currentClubId].tasks = onSnapshot(tasksRef, (snapshot) => {
                document.querySelectorAll('.kanban-column').forEach(col => col.innerHTML = '');
                snapshot.forEach(doc => renderTaskCard({ id: doc.id, ...doc.data() }));
                setupDragAndDrop();
            });

            document.getElementById('add-task-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const input = document.getElementById('task-title-input');
                const title = input.value.trim();
                if (title) {
                    try {
                        await addDoc(tasksRef, { title, status: 'todo', createdAt: new Date() });
                        input.value = '';
                    } catch (error) { showErrorModal("Não foi possível adicionar a tarefa."); }
                }
            });
        }
        
        function renderTaskCard(task) {
            const column = document.getElementById(`kanban-${task.status}`);
            if (!column) return;

            const card = document.createElement('div');
            card.id = `task-${task.id}`;
            card.dataset.id = task.id;
            card.draggable = true;
            card.className = 'bg-white p-3 rounded-md shadow cursor-grab active:cursor-grabbing';
            card.innerHTML = `
                <p>${task.title}</p>
                <button class="delete-task-btn absolute top-1 right-1 text-xs text-gray-400 hover:text-red-500 hidden"><i class="fas fa-times-circle"></i></button>
            `;
            card.style.position = 'relative';

            card.addEventListener('mouseenter', () => card.querySelector('.delete-task-btn').classList.remove('hidden'));
            card.addEventListener('mouseleave', () => card.querySelector('.delete-task-btn').classList.add('hidden'));
            card.querySelector('.delete-task-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                showConfirmModal(`Tem a certeza que quer apagar a tarefa "${task.title}"?`, () => deleteTask(task.id));
            });

            column.appendChild(card);
        }

        async function deleteTask(taskId) {
            try {
                const taskRef = doc(db, `artifacts/${appId}/users/${userId}/clubs/${currentClubId}/tasks`, taskId);
                await deleteDoc(taskRef);
            } catch (error) { showErrorModal("Não foi possível apagar a tarefa."); }
        }

        function setupDragAndDrop() {
            const columns = document.querySelectorAll('.kanban-column');
            let draggedItem = null;

            document.querySelectorAll('[draggable="true"]').forEach(item => {
                item.addEventListener('dragstart', (e) => {
                    draggedItem = item;
                    setTimeout(() => item.style.display = 'none', 0);
                });

                item.addEventListener('dragend', (e) => {
                    setTimeout(() => {
                        if (draggedItem) {
                            draggedItem.style.display = 'block';
                            draggedItem = null;
                        }
                    }, 0);
                });
            });

            columns.forEach(column => {
                column.addEventListener('dragover', e => {
                    e.preventDefault();
                    column.classList.add('bg-gray-200');
                });
                
                column.addEventListener('dragleave', e => {
                    column.classList.remove('bg-gray-200');
                });

                column.addEventListener('drop', async (e) => {
                    e.preventDefault();
                    column.classList.remove('bg-gray-200');
                    if (draggedItem) {
                        column.appendChild(draggedItem);
                        const taskId = draggedItem.dataset.id;
                        const newStatus = column.dataset.status;
                        const taskRef = doc(db, `artifacts/${appId}/users/${userId}/clubs/${currentClubId}/tasks`, taskId);
                        try {
                            await updateDoc(taskRef, { status: newStatus });
                        } catch (error) {
                            showErrorModal("Não foi possível mover a tarefa.");
                            renderProjectsTab();
                        }
                    }
                });
            });
        }
        
        // --- ABA: RECURSOS ---
        function renderResourcesTab() {
            clubTabContent.innerHTML = `
                <h3 class="text-xl font-semibold mb-4">Recursos do Clube</h3>
                <form id="add-resource-form" class="p-4 bg-gray-50 rounded-lg mb-6">
                    <h4 class="font-semibold mb-2">Adicionar Novo Recurso (Link)</h4>
                    <div class="space-y-3">
                        <input type="text" id="resource-name" placeholder="Nome do Recurso" class="w-full px-3 py-2 border rounded-md" required>
                        <input type="url" id="resource-url" placeholder="URL do Recurso (ex: https://...)" class="w-full px-3 py-2 border rounded-md" required>
                        <textarea id="resource-description" placeholder="Breve descrição..." class="w-full px-3 py-2 border rounded-md" rows="2"></textarea>
                    </div>
                    <div class="text-right mt-3">
                        <button type="submit" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600">Adicionar Recurso</button>
                    </div>
                </form>
                <div id="resources-list" class="space-y-3"></div>
            `;

            const resourcesRef = collection(db, `artifacts/${appId}/users/${userId}/clubs/${currentClubId}/resources`);
            unsubscribeClubData[currentClubId].resources = onSnapshot(resourcesRef, (snapshot) => {
                const resourcesList = document.getElementById('resources-list');
                if (!resourcesList) return;
                resourcesList.innerHTML = '';
                if (snapshot.empty) {
                    resourcesList.innerHTML = '<p class="text-gray-500">Nenhum recurso adicionado.</p>';
                } else {
                    const resources = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    resources.sort((a, b) => b.createdAt.toDate() - a.createdAt.toDate());

                    resources.forEach(resource => {
                        const resourceEl = document.createElement('div');
                        resourceEl.className = 'bg-white p-4 rounded-lg shadow-sm flex justify-between items-start';
                        resourceEl.innerHTML = `
                            <div>
                                <a href="${resource.url}" target="_blank" rel="noopener noreferrer" class="font-bold text-indigo-600 hover:underline">${resource.name} <i class="fas fa-external-link-alt text-xs"></i></a>
                                <p class="text-sm text-gray-600 mt-1">${resource.description || 'Sem descrição.'}</p>
                            </div>
                            <button class="text-red-500 hover:text-red-700 ml-4"><i class="fas fa-trash-alt"></i></button>
                        `;
                        resourceEl.querySelector('button').addEventListener('click', () => deleteResource(resource.id));
                        resourcesList.appendChild(resourceEl);
                    });
                }
            });

            document.getElementById('add-resource-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = document.getElementById('resource-name').value.trim();
                const url = document.getElementById('resource-url').value.trim();
                const description = document.getElementById('resource-description').value.trim();
                if (name && url) {
                    try {
                        await addDoc(resourcesRef, { name, url, description, createdAt: new Date() });
                        e.target.reset();
                    } catch (error) { showErrorModal("Não foi possível adicionar o recurso."); }
                }
            });
        }

        async function deleteResource(resourceId) {
            try {
                const resourceRef = doc(db, `artifacts/${appId}/users/${userId}/clubs/${currentClubId}/resources`, resourceId);
                await deleteDoc(resourceRef);
            } catch (error) { showErrorModal("Não foi possível apagar o recurso."); }
        }

        // --- ABA: PORTFÓLIO ---
        function renderPortfolioTab() {
            clubTabContent.innerHTML = `
                <div class="flex justify-between items-center mb-6 no-print">
                    <h3 class="text-xl font-semibold">Portfólio do Clube</h3>
                    <button id="print-portfolio-btn" class="bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-700">
                        <i class="fas fa-print mr-2"></i>Imprimir Portfólio
                    </button>
                </div>
                <div id="portfolio-print-area" class="p-4 border rounded-lg bg-white">
                    <!-- Conteúdo do portfólio gerado aqui -->
                    <p class="text-gray-500">O portfólio do clube será apresentado aqui.</p>
                </div>
            `;
            generatePortfolio();
            document.getElementById('print-portfolio-btn').addEventListener('click', () => {
                window.print();
            });
        }

        async function generatePortfolio() {
            const portfolioArea = document.getElementById('portfolio-print-area');
            if (!portfolioArea) return;
            portfolioArea.innerHTML = '<div class="text-center p-8"><i class="fas fa-spinner fa-spin text-3xl text-indigo-500"></i><p class="mt-2">A gerar portfólio...</p></div>';

            try {
                // Fetch all data
                const { clubName, clubDescription } = await getClubDataForExport();
                const goalsSnap = await getDocs(collection(db, `artifacts/${appId}/users/${userId}/clubs/${currentClubId}/goals`));
                const announcementsSnap = await getDocs(collection(db, `artifacts/${appId}/users/${userId}/clubs/${currentClubId}/announcements`));
                const tasksSnap = await getDocs(query(collection(db, `artifacts/${appId}/users/${userId}/clubs/${currentClubId}/tasks`), where("status", "==", "done")));

                const achievedGoals = goalsSnap.docs.map(d => d.data());
                const announcements = announcementsSnap.docs.map(d => d.data()).sort((a,b) => b.createdAt.toDate() - a.createdAt.toDate());
                const completedTasks = tasksSnap.docs.map(d => d.data());

                // Build HTML
                let html = `<h1 class="text-3xl font-bold text-center mb-2" style="color: ${clubNameTitle.style.color};">${clubName}</h1>`;
                html += `<p class="text-center text-gray-600 mb-8">${clubDescription}</p>`;
                
                // Metas Atingidas
                if(achievedGoals.some(g => g.achieved)) {
                    html += `<h2 class="text-2xl font-bold mt-8 mb-4 border-b-2 pb-2">Metas Atingidas</h2>`;
                    html += `<ul class="list-disc list-inside space-y-2">`;
                    achievedGoals.filter(g => g.achieved).forEach(goal => {
                        html += `<li class="text-green-700"><span class="font-semibold">${goal.title}</span>: ${goal.description}</li>`;
                    });
                    html += `</ul>`;
                }

                // Projetos Concluídos
                if(completedTasks.length > 0) {
                    html += `<h2 class="text-2xl font-bold mt-8 mb-4 border-b-2 pb-2">Projetos Concluídos</h2>`;
                    html += `<ul class="list-disc list-inside space-y-1">`;
                    completedTasks.forEach(task => {
                        html += `<li>${task.title}</li>`;
                    });
                    html += `</ul>`;
                }

                // Últimos Anúncios
                if(announcements.length > 0) {
                    html += `<h2 class="text-2xl font-bold mt-8 mb-4 border-b-2 pb-2">Últimos Anúncios</h2>`;
                    announcements.slice(0, 5).forEach(ann => { // Limitar aos 5 mais recentes
                        html += `<div class="p-3 bg-gray-50 rounded-md mb-3">
                                    <p class="whitespace-pre-wrap">${ann.content}</p>
                                    <p class="text-xs text-right text-gray-500 mt-1">Publicado em: ${ann.createdAt.toDate().toLocaleDateString('pt-PT')}</p>
                                 </div>`;
                    });
                }

                portfolioArea.innerHTML = html;

            } catch (error) {
                console.error("Erro ao gerar portfólio:", error);
                showErrorModal("Não foi possível gerar o portfólio.");
                portfolioArea.innerHTML = `<p class="text-red-500">Ocorreu um erro ao gerar o portfólio.</p>`;
            }
        }


        // --- LÓGICA DE EXPORTAÇÃO ---
        async function getClubDataForExport() {
            const clubRef = doc(db, `artifacts/${appId}/users/${userId}/clubs`, currentClubId);
            const clubSnap = await getDoc(clubRef);
            if (clubSnap.exists()) {
                return { clubName: clubSnap.data().name, clubDescription: clubSnap.data().description };
            }
            return { clubName: "Clube", clubDescription: "" };
        }

        async function exportMembersToCSV() {
            try {
                const membersRef = collection(db, `artifacts/${appId}/users/${userId}/clubs/${currentClubId}/members`);
                const membersSnap = await getDocs(membersRef);
                const members = membersSnap.docs.map(doc => doc.data());
                
                if (members.length === 0) {
                    showErrorModal("Não há membros para exportar.");
                    return;
                }

                let csvContent = "data:text/csv;charset=utf-8,Nome do Aluno\n";
                members.forEach(member => {
                    csvContent += `"${member.name}"\n`;
                });

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `membros_${clubNameTitle.textContent.replace(/\s+/g, '_')}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } catch (error) {
                showErrorModal("Ocorreu um erro ao exportar para CSV.");
            }
        }

        async function exportMembersToPDF() {
            try {
                const { clubName } = await getClubDataForExport();
                const membersRef = collection(db, `artifacts/${appId}/users/${userId}/clubs/${currentClubId}/members`);
                const membersSnap = await getDocs(membersRef);
                const members = membersSnap.docs.map(doc => [doc.data().name]);
                
                if (members.length === 0) {
                    showErrorModal("Não há membros para exportar.");
                    return;
                }

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                doc.text(`Lista de Membros - ${clubName}`, 14, 16);
                doc.autoTable({
                    head: [['Nome do Aluno']],
                    body: members,
                    startY: 20,
                });
                
                doc.save(`membros_${clubName.replace(/\s+/g, '_')}.pdf`);
            } catch (error) {
                showErrorModal("Ocorreu um erro ao exportar para PDF.");
                console.error(error);
            }
        }

        async function exportAttendanceToCSV() {
            try {
                const dateStr = document.getElementById('attendance-date').value;
                const { clubName } = await getClubDataForExport();
                
                const membersRef = collection(db, `artifacts/${appId}/users/${userId}/clubs/${currentClubId}/members`);
                const membersSnap = await getDocs(membersRef);
                const allMembers = membersSnap.docs.map(d => ({ id: d.id, ...d.data() }));
                
                const attendanceRef = doc(db, `artifacts/${appId}/users/${userId}/clubs/${currentClubId}/attendance`, `attendance-${dateStr}`);
                const attendanceSnap = await getDoc(attendanceRef);
                const presentIds = attendanceSnap.exists() ? attendanceSnap.data().presentIds : [];
                
                if (allMembers.length === 0) {
                    showErrorModal("Não há membros para gerar a lista de presenças.");
                    return;
                }

                let csvContent = "data:text/csv;charset=utf-8,Nome do Aluno,Presença\n";
                allMembers.forEach(member => {
                    const status = presentIds.includes(member.id) ? "Presente" : "Ausente";
                    csvContent += `"${member.name}","${status}"\n`;
                });

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `presencas_${clubName.replace(/\s+/g, '_')}_${dateStr}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } catch (error) {
                showErrorModal("Ocorreu um erro ao exportar para CSV.");
            }
        }

        async function exportAttendanceToPDF() {
            try {
                const dateStr = document.getElementById('attendance-date').value;
                const { clubName } = await getClubDataForExport();
                
                const membersRef = collection(db, `artifacts/${appId}/users/${userId}/clubs/${currentClubId}/members`);
                const membersSnap = await getDocs(membersRef);
                const allMembers = membersSnap.docs.map(d => ({ id: d.id, ...d.data() }));

                const attendanceRef = doc(db, `artifacts/${appId}/users/${userId}/clubs/${currentClubId}/attendance`, `attendance-${dateStr}`);
                const attendanceSnap = await getDoc(attendanceRef);
                const presentIds = attendanceSnap.exists() ? attendanceSnap.data().presentIds : [];

                if (allMembers.length === 0) {
                    showErrorModal("Não há membros para gerar a lista de presenças.");
                    return;
                }
                
                const bodyData = allMembers.map(member => {
                    const status = presentIds.includes(member.id) ? "Presente" : "Ausente";
                    return [member.name, status];
                });

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                const formattedDate = new Date(dateStr + 'T00:00:00').toLocaleDateString('pt-PT');
                doc.text(`Registo de Presenças - ${clubName}`, 14, 16);
                doc.text(`Data: ${formattedDate}`, 14, 22);

                doc.autoTable({
                    head: [['Nome do Aluno', 'Presença']],
                    body: bodyData,
                    startY: 30,
                });
                
                doc.save(`presencas_${clubName.replace(/\s+/g, '_')}_${dateStr}.pdf`);
            } catch (error) {
                showErrorModal("Ocorreu um erro ao exportar para PDF.");
                console.error(error);
            }
        }
    </script>

</body>
</html>
